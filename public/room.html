<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chi ti·∫øt Resort</title>
<link rel="stylesheet" href="room.css" />
<!-- FIXED FONT AWESOME ISSUE: Using stable CDN link -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
 /* Reset for better consistency */
 body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
 main { max-width: 900px; margin: 20px auto; padding: 0 15px; }

 /* Header & Footer */
 header { 
    text-align: center; 
    padding: 20px 0; 
    background: #007bff; 
    color: white; 
    margin: 0;
    position: relative; 
  }
 footer p { text-align: center; padding: 10px 0; background: #333; color: white; margin-top: 20px; }

  /* Return Button Styling */
  .return-btn {
    position: absolute;
    left: 20px;
    right: auto; 
    top: 50%;
    transform: translateY(-50%);
    padding: 8px 15px;
    background-color: #f8f9fa;
    color: #007bff;
    border: 2px solid #007bff;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    transition: all 0.2s ease-in-out;
    z-index: 10;
  }

  .return-btn:hover {
    background-color: #007bff;
    color: white;
    border-color: white;
  }

 /* Room Detail Section */
 .room-detail { display: flex; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 40px; }
 .room-image-container { flex: 1; margin-right: 20px; }
 .room-image-container img { width: 100%; height: auto; border-radius: 10px; }
 .room-info { flex: 2; }
 .price { font-size: 1.5em; color: #d9534f; font-weight: bold; margin-bottom: 15px; }
 .location { color: #555; margin-bottom: 10px; }

 /* Review Form & List Styles */
 .reviews-section {
 margin: 40px auto;
 padding: 20px;
 max-width: 100%;
 background: #fafafa;
 border-radius: 12px;
 box-shadow: 0 2px 8px rgba(0,0,0,0.1);
 }

 /* --- LISTBOX STYLING (REPLACING STARS) --- */
 .review-form label {
 display: block;
 margin-bottom: 5px;
 font-weight: bold;
 }
 #rating-select {
  display: block;
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background-color: white;
  /* Custom arrow styling for aesthetics */
  appearance: none; 
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.9L146.2%20210.7L5.4%2069.9h281.6z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 10px;
  cursor: pointer;
 }
 /* ----------------------------------------- */
 

 /* Unicode Stars in Displayed Reviews */
 .review-header .stars {
 color: gold;
 font-size: 1.2em;
 letter-spacing: 1px;
 }
 
 .review-header .stars::before {
  content: attr(data-unfilled);
  color: #ccc;
 }
 
 .review-form textarea {
 width: 100%;
 margin-top: 10px;
 padding: 10px;
 border-radius: 8px;
 border: 1px solid #ccc;
 resize: vertical;
 }

 .submit-btn, .book-btn {
 margin-top: 10px;
 padding: 10px 20px;
 background: #007bff;
 color: white;
 border: none;
 border-radius: 8px;
 cursor: pointer;
 transition: background 0.3s;
 }
 .submit-btn:hover, .book-btn:hover { background: #0056b3; }

 .review-item {
 background: #fff;
 border-radius: 8px;
 padding: 15px;
 margin-bottom: 15px;
 box-shadow: 0 1px 3px rgba(0,0,0,0.1);
 }
 .review-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 5px;
 }
 .review-item small { color: #888; display: block; margin-top: 5px; font-size: 0.85em; }

 @media (max-width: 768px) {
 .room-detail { flex-direction: column; }
 .room-image-container { margin-right: 0; margin-bottom: 20px; }
 }
</style>
</head>
<body>
<header>
<h1 class="site-title">üå¥ Resort Booking</h1>
 <a href="home.html" class="return-btn">
  <i class="fas fa-home"></i> V·ªÅ trang ch·ªß
 </a>
</header>

<main>
 <section id="room-detail" class="room-detail">
 <div class="room-image-container">
  <img id="room-image" src="assets/default.jpg" alt="Resort image">
 </div>

 <div class="room-info">
  <h2 id="room-name">ƒêang t·∫£i...</h2>
  <p id="room-location" class="location"><i class="fas fa-map-marker-alt"></i></p>
  <p id="room-type"></p>
  <p id="room-capacity"></p>
  <p id="room-price" class="price"></p>
  <p id="room-description" class="description"></p>
  <div class="amenities" id="room-amenities"></div>

  <button id="book-btn" class="book-btn">ƒê·∫∑t ph√≤ng ngay</button>
 </div>
 </section>

  <section id="reviews" class="reviews-section">
 <h3>ƒê√°nh gi√° & B√¨nh lu·∫≠n</h3>
 <div id="review-list"></div>

 <form id="review-form" class="review-form">
  <label for="rating-select">ƒê√°nh gi√° c·ªßa b·∫°n:</label>
  <!-- ‚úÖ Rating is now a list box (select element) -->
  <select id="rating-select" required>
   <option value="" disabled selected>Ch·ªçn s·ªë sao</option>
   <option value="1">1 Sao</option>
   <option value="2">2 Sao</option>
   <option value="3">3 Sao</option>
   <option value="4">4 Sao</option>
   <option value="5">5 Sao</option>
  </select>

  <textarea id="comment" rows="3" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..."></textarea>
  <button type="submit" class="submit-btn">G·ª≠i ƒë√°nh gi√°</button>
 </form>
 </section>
</main>

<footer>
 <p>¬© 2025 Resort Booking</p>
</footer>

<script>
 const API_BASE = window.location.origin + '/api';
 // Removed global 'let selectedRating' as we now read directly from the select element

 function formatCurrency(amount) {
 return new Intl.NumberFormat('vi-VN', {
  style: 'currency',
  currency: 'VND'
 }).format(amount);
 }

 function getRoomIdFromUrl() {
 const params = new URLSearchParams(window.location.search);
 return params.get('id');
 }

 async function loadReviews(roomId) {
 const container = document.getElementById('review-list');
 container.innerHTML = "<p>ƒêang t·∫£i ƒë√°nh gi√°...</p>";

 try {
  const res = await fetch(`${API_BASE}/reviews/${roomId}`);
  if (!res.ok) throw new Error('L·ªói khi t·∫£i ƒë√°nh gi√°');
  const reviews = await res.json();

  container.innerHTML = reviews.length
  ? reviews.map(r => `
   <div class="review-item">
   <div class="review-header">
    <strong>${r.username || 'Ng∆∞·ªùi d√πng'}</strong>
    <span class="stars">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5 - r.rating)}</span>
   </div>
   <p>${r.comment}</p>
   <small>${new Date(r.created_at).toLocaleString('vi-VN')}</small>
   </div>
  `).join('')
  : "<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>";
 } catch (err) {
  console.error('L·ªói t·∫£i ƒë√°nh gi√°:', err);
  container.innerHTML = "<p>L·ªói khi t·∫£i ƒë√°nh gi√°.</p>";
 }
 }

 async function loadRoomDetail() {
 const id = getRoomIdFromUrl();
 if (!id) {
  document.getElementById('room-detail').innerHTML = "<p>Kh√¥ng t√¨m th·∫•y resort.</p>";
  return;
 }

 try {
  const res = await fetch(`${API_BASE}/rooms/${id}`);
  if (!res.ok) throw new Error('API error');
  const room = await res.json();

  document.getElementById('room-image').src =
  (typeof room.images === 'string' ? room.images.split(',')[0] : room.images?.[0]) || 'assets/default.jpg';

  document.getElementById('room-name').textContent = room.resort_name || "Kh√¥ng c√≥ t√™n";
  document.getElementById('room-location').innerHTML =
  `<i class="fas fa-map-marker-alt"></i> ${room.location || ''}`;
  document.getElementById('room-type').textContent = `Lo·∫°i ph√≤ng: ${room.room_type || ''}`;
  document.getElementById('room-capacity').textContent = `S·ª©c ch·ª©a: ${room.capacity || 1} kh√°ch`;
  document.getElementById('room-price').textContent =
  `${formatCurrency(room.price_per_night || 0)} / ƒë√™m`;
  document.getElementById('room-description').textContent = room.description || "Ch∆∞a c√≥ m√¥ t·∫£.";

  const amenitiesContainer = document.getElementById('room-amenities');
  amenitiesContainer.innerHTML = '';
  if (room.amenities && room.amenities.length) {
  amenitiesContainer.innerHTML = `
   <h3>Ti·ªán nghi</h3>
   <ul>${room.amenities.map(a => `<li>${a}</li>`).join('')}</ul>
  `;
  }

  await loadReviews(id);
 } catch (err) {
  console.error('L·ªói t·∫£i resort:', err);
  document.getElementById('room-detail').innerHTML = "<p>L·ªói t·∫£i th√¥ng tin resort.</p>";
 }
 }

 document.addEventListener('DOMContentLoaded', () => {
 loadRoomDetail();

 // ‚úÖ REMOVED: Star rating click handler is no longer needed

 // Submit review handler
 document.getElementById('review-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const comment = document.getElementById('comment').value.trim();
  const roomId = getRoomIdFromUrl();
  
  // ‚úÖ GET RATING FROM SELECT BOX
  const ratingSelect = document.getElementById('rating-select');
  const selectedRating = parseInt(ratingSelect.value); // Get the selected value

  // ‚úÖ VALIDATION CHECK
  if (isNaN(selectedRating) || selectedRating < 1 || selectedRating > 5) { 
  console.warn('Vui l√≤ng ch·ªçn s·ªë sao.'); 
  return;
  }
  if (!comment) {
  console.warn('Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n.');
  return;
  }
  
  const username = localStorage.getItem('username') || "Kh√°ch ·∫©n danh"; 

  try {
  // Show a temporary loading state
  const submitButton = document.querySelector('.submit-btn');
  submitButton.textContent = 'ƒêang g·ª≠i...';
  submitButton.disabled = true;

  const res = await fetch(`${API_BASE}/reviews`, { 
   method: 'POST',
   headers: { 'Content-Type': 'application/json' },
   body: JSON.stringify({ 
   rating: selectedRating, 
   comment, 
   room_id: roomId, 
   username 
   })
  });

  submitButton.textContent = 'G·ª≠i ƒë√°nh gi√°';
  submitButton.disabled = false;

  if (!res.ok) throw new Error('L·ªói khi g·ª≠i ƒë√°nh gi√°');

  console.log('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
  document.getElementById('comment').value = '';
  // ‚úÖ RESET SELECT BOX
  ratingSelect.value = ""; 
  await loadReviews(roomId);
  } catch (err) {
  console.error('L·ªói g·ª≠i ƒë√°nh gi√°:', err);
  }
 });
 });
</script>
</body>
</html>
