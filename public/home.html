<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resort Booking ‚Äì Trang ch·ªß</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="home.css">
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <h1>Resort Booking</h1>
      </div>
      <nav class="navbar-menu">
        <a href="promotions.html">Khuy·∫øn m√£i</a>
        <a href="supports/support.html">H·ªó tr·ª£</a>
        <a href="">H·ª£p t√°c</a>
        <a href="my_bookings.html">ƒê·∫∑t ch·ªó</a>
        
        <!-- Ph·∫ßn hi·ªÉn th·ªã khi ch∆∞a ƒëƒÉng nh·∫≠p -->
        <div id="auth-buttons">
          <a href="login.html" class="btn-login">ƒêƒÉng nh·∫≠p</a>
          <a href="register.html" class="btn-register">ƒêƒÉng k√Ω</a>
        </div>

        <!-- Ph·∫ßn hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
        <div id="user-section">
          <!-- Icon + Username = clickable link to profile -->
          <a href="profile.html" class="user-profile-link" id="profile-link">
            <i class="fas fa-user-circle user-icon"></i>
            <span id="username-display"></span>
          </a>
          <button id="logout-btn" class="btn-logout">ƒêƒÉng xu·∫•t</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- SEARCH -->
  <div class="search-container">
    <div class="search-header">
      <h2>T√¨m Resort Ho√†n H·∫£o</h2>
      <p>Kh√°m ph√° nh·ªØng k·ª≥ ngh·ªâ tuy·ªát v·ªùi</p>
    </div>

    <section class="search-form">
      <label>
        <span>ƒê·ªãa ƒëi·ªÉm</span>
        <input type="text" id="location" placeholder="Nh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm">
      </label>
      <label>
        <span>Lo·∫°i ph√≤ng</span>
        <select id="roomType">
          <option value="">T·∫•t c·∫£ lo·∫°i ph√≤ng</option>
        </select>
      </label>
      <button id="searchBtn" class="search-btn-icon">
        <i class="fas fa-search"></i>
      </button>
    </section>
  </div>

  <!-- MAIN CONTENT -->
  <section class="container">
    <!-- VOUCHERS -->
    <h2 class="section-title">üé´ ∆Øu ƒê√£i ƒê·∫∑c Bi·ªát</h2>
    <div id="vouchers-container" class="vouchers-grid"></div>

    <!-- DESTINATIONS -->
    <h2 class="section-title">üìç ƒêi·ªÉm ƒê·∫øn Ph·ªï Bi·∫øn</h2>
    <div id="destinations-container" class="destinations-grid"></div>

    <!-- RESORTS -->
    <div id="room-cards-container"></div>
    <div id="pagination-container" class="pagination"></div>
  </section>

  <!-- WHY CHOOSE US SECTION -->
  <section class="why-choose-us">
    <h2>V√¨ sao n√™n ch·ªçn Resort Booking?</h2>
    <div class="reasons">
      <div class="reason">
        <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="ƒê·∫∑t ph√≤ng d·ªÖ d√†ng">
        <h4>ƒê·∫∑t ch·ªó d·ªÖ d√†ng</h4>
        <p>Ch·ªâ v√†i b∆∞·ªõc ƒë∆°n gi·∫£n ƒë·ªÉ ho√†n t·∫•t ƒë·∫∑t ph√≤ng c·ªßa b·∫°n.</p>
      </div>
      <div class="reason">
        <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="∆Øu ƒë√£i h·∫•p d·∫´n">
        <h4>∆Øu ƒë√£i h·∫•p d·∫´n</h4>
        <p>Gi√° t·ªët nh·∫•t m·ªói ng√†y d√†nh cho kh√°ch h√†ng th√¢n thi·∫øt.</p>
      </div>
      <div class="reason">
        <img src="https://cdn-icons-png.flaticon.com/512/906/906334.png" alt="H·ªó tr·ª£ 24/7">
        <h4>H·ªó tr·ª£ 24/7</h4>
        <p>ƒê·ªôi ng≈© CSKH s·∫µn s√†ng h·ªó tr·ª£ b·∫°n m·ªçi l√∫c, m·ªçi n∆°i.</p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="footer-container">
      <div class="footer-links">
        <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
        <span>|</span>
        <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
        <span>|</span>
        <a href="#">Li√™n h·ªá</a>
      </div>
      <div class="footer-social">
        <p>Theo d√µi ch√∫ng t√¥i</p>
        <div class="social-icons">
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733558.png" alt="Instagram"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/2504/2504989.png" alt="Telegram"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/3046/3046126.png" alt="TikTok"></a>
        </div>
      </div>
      <p>&copy; 2025 <span>Resort Booking</span>. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
  <script>
    // ===== AUTH MANAGEMENT (NEW) =====
    function updateNavbar() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');

      const authButtons = document.getElementById('auth-buttons');
      const userSection = document.getElementById('user-section');
      const usernameDisplay = document.getElementById('username-display');

      if (token && username) {
        if (authButtons) authButtons.classList.add('hidden');
        if (userSection) {
          userSection.classList.add('active');
          if (usernameDisplay) usernameDisplay.textContent = username;
        }
      } else {
        if (authButtons) authButtons.classList.remove('hidden');
        if (userSection) userSection.classList.remove('active');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      updateNavbar();
      window.location.href = '/';
    }

    // ===== ORIGINAL CODE (KEPT INTACT) =====
    document.addEventListener('DOMContentLoaded', async () => {
      // Update navbar khi trang load
      updateNavbar();

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          logout();
        });
      }

      let allRooms = [];
      let currentPage = 1;
      const itemsPerPage = 6;
      const API_BASE = 'https://api-resort.onrender.com';

      const PLACEHOLDER_SVG = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22%3ENo Image%3C/text%3E%3C/svg%3E';

      function resolveImageUrl(url) {
        if (!url) return PLACEHOLDER_SVG;
        if (/^https?:\/\//i.test(url)) return url;
        return API_BASE + '/uploads/' + url;
      }

      function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(price);
      }

      function getLocationName(key) {
        const map = {
          'da-lat': 'ƒê√† L·∫°t',
          'ha-long': 'H·∫° Long',
          'phu-quoc': 'Ph√∫ Qu·ªëc',
          'nha-trang': 'Nha Trang',
          'da-nang': 'ƒê√† N·∫µng',
          'sapa': 'Sapa',
          'hoi-an': 'H·ªôi An',
          'ha-noi': 'H√† N·ªôi'
        };
        return map[key] || key || 'Ch∆∞a x√°c ƒë·ªãnh';
      }

      // ===== FETCH VOUCHERS =====
      async function fetchVouchers() {
        try {
          const response = await fetch(`${API_BASE}/api/discounts`);
          if (response.ok) {
            const vouchers = await response.json();
            renderVouchers(vouchers);
          }
        } catch (error) {
          console.log('Vouchers API not available');
        }
      }

      function renderVouchers(vouchers) {
        const container = document.getElementById('vouchers-container');
        container.innerHTML = '';

        if (!vouchers || vouchers.length === 0) return;

        vouchers.slice(0, 4).forEach(voucher => {
          const card = document.createElement('div');
          card.className = 'voucher-card';
          
          const validUntil = new Date(voucher.valid_until).toLocaleDateString('vi-VN');
          const discountText = voucher.discount_type === 'percentage' 
            ? `Gi·∫£m ${voucher.value}%` 
            : `Gi·∫£m ${voucher.value}ƒë`;
          
          card.innerHTML = `
            <div class="voucher-code">${voucher.code}</div>
            <h3>${voucher.name}</h3>
            <p>${voucher.description}</p>
            <p style="margin-top: 8px; font-size: 13px; color: #667eea; font-weight: 600;">${discountText}</p>
            <div class="voucher-expire">H·∫°n: ${validUntil}</div>
          `;
          container.appendChild(card);
        });
      }

      // ===== EXTRACT & RENDER DESTINATIONS =====
      function renderDestinations(rooms) {
        const container = document.getElementById('destinations-container');
        container.innerHTML = '';

        const locations = [...new Set(rooms.map(r => r.location))];
        const locationMap = {
          'da-lat': 'ƒê√† L·∫°t',
          'ha-long': 'H·∫° Long',
          'phu-quoc': 'Ph√∫ Qu·ªëc',
          'nha-trang': 'Nha Trang',
          'da-nang': 'ƒê√† N·∫µng',
          'sapa': 'Sapa',
          'hoi-an': 'H·ªôi An',
          'ha-noi': 'H√† N·ªôi'
        };

        locations.forEach(loc => {
          if (!loc) return;
          const card = document.createElement('a');
          card.className = 'destination-card';
          card.href = `destinations.html?location=${loc}`;

          const imgUrls = {
            'da-lat': 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&h=150&fit=crop',
            'ha-long': 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=300&h=150&fit=crop',
            'phu-quoc': 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=300&h=150&fit=crop',
            'nha-trang': 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=300&h=150&fit=crop',
            'da-nang': 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=300&h=150&fit=crop',
            'sapa': 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&h=150&fit=crop',
            'hoi-an': 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=300&h=150&fit=crop',
            'ha-noi': 'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?w=300&h=150&fit=crop'
          };

          card.innerHTML = `
            <div class="destination-card-image">
              <img src="${imgUrls[loc] || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22150%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22300%22 height=%22150%22/%3E%3C/svg%3E'}" alt="${locationMap[loc] || loc}">
            </div>
            <div class="destination-card-name">${locationMap[loc] || loc}</div>
          `;
          container.appendChild(card);
        });
      }

      // ===== GROUP ROOMS BY RESORT =====
      function groupRoomsByResort(rooms) {
        const grouped = {};
        rooms.forEach(room => {
          const resort = room.resort_name || 'Kh√¥ng x√°c ƒë·ªãnh';
          if (!grouped[resort]) grouped[resort] = [];
          grouped[resort].push(room);
        });
        return grouped;
      }

      // ===== RENDER ROOMS =====
      function renderRooms(roomsToDisplay) {
        const container = document.getElementById('room-cards-container');
        container.innerHTML = '';

        if (!roomsToDisplay || roomsToDisplay.length === 0) {
          container.innerHTML = '<p style="text-align:center; padding:40px; color:#718096;">Kh√¥ng t√¨m th·∫•y ph√≤ng ph√π h·ª£p</p>';
          return;
        }

        const grouped = groupRoomsByResort(roomsToDisplay);

        Object.entries(grouped).forEach(([resortName, rooms]) => {
          const title = document.createElement('h3');
          title.className = 'resort-group-title';
          title.textContent = `üè® ${resortName}`;
          container.appendChild(title);

          const grid = document.createElement('div');
          grid.className = 'rooms-grid';

          rooms.forEach(room => {
            const card = document.createElement('div');
            card.className = 'room-card';
            card.style.cursor = 'pointer';
            card.onclick = () => window.location.href = `resort_detail.html?id=${room.id}`;

            const imageUrl = resolveImageUrl(room.images?.[0]);

            card.innerHTML = `
              <div class="room-card-image">
                <img src="${imageUrl}" alt="${room.room_type}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22%3ENo Image%3C/text%3E%3C/svg%3E'">
              </div>

              <div class="room-card-content">
                <h3>${room.room_type}</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${getLocationName(room.location)}</p>
                <p><i class="fas fa-door-open"></i> ${room.num_bed || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
                <div class="room-price">${formatPrice(room.price_per_night)}/ƒë√™m</div>
              </div>
            `;

            grid.appendChild(card);
          });

          container.appendChild(grid);
        });
      }

      // ===== FETCH DATA =====
      async function fetchRooms() {
        try {
          const response = await fetch(`${API_BASE}/api/rooms`);
          if (!response.ok) throw new Error('Network error');
          allRooms = await response.json();
          populateRoomTypes();
          renderDestinations(allRooms);
        } catch (error) {
          console.error('Error:', error);
          allRooms = [];
        }
      }

      function populateRoomTypes() {
        const select = document.getElementById('roomType');
        const types = [...new Set(allRooms.map(r => r.room_type))];
        types.forEach(type => {
          if (type) {
            const opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type;
            select.appendChild(opt);
          }
        });
      }

      // ===== PAGINATION =====
      function renderPagination() {
        const container = document.getElementById('pagination-container');
        container.innerHTML = '';
        const total = Math.ceil(allRooms.length / itemsPerPage);

        if (total <= 1) return;

        for (let i = 1; i <= total; i++) {
          const btn = document.createElement('button');
          btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
          btn.textContent = i;
          btn.onclick = () => {
            currentPage = i;
            const start = (i - 1) * itemsPerPage;
            renderRooms(allRooms.slice(start, start + itemsPerPage));
            renderPagination();
            window.scrollTo({ top: 300, behavior: 'smooth' });
          };
          container.appendChild(btn);
        }
      }

      function renderCurrentPage() {
        const start = (currentPage - 1) * itemsPerPage;
        renderRooms(allRooms.slice(start, start + itemsPerPage));
      }

      // ===== SEARCH =====
      document.getElementById('searchBtn').onclick = () => {
        const location = document.getElementById('location').value.toLowerCase();
        const type = document.getElementById('roomType').value;

        const filtered = allRooms.filter(room => {
          const matchLoc = !location || 
                          getLocationName(room.location).toLowerCase().includes(location) ||
                          (room.resort_name && room.resort_name.toLowerCase().includes(location));
          const matchType = !type || room.room_type === type;
          return matchLoc && matchType;
        });

        document.getElementById('pagination-container').innerHTML = '';
        renderRooms(filtered);
      };

      // ===== INIT =====
      await fetchRooms();
      await fetchVouchers();
      renderCurrentPage();
      renderPagination();
    });
  </script>
</body>
</html>