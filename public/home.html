<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resort Booking â€“ Trang chá»§</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="home.css">
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <h1>Resort Booking</h1>
      </div>
      <nav class="navbar-menu">
        <a href="promotions.html">Khuyáº¿n mÃ£i</a>
        <a href="supports/support.html">Há»— trá»£</a>
        <a href="">Há»£p tÃ¡c</a>
        <a href="my_bookings.html">Äáº·t chá»—</a>

        <a href="notifications.html" class="notif-btn">
                  ğŸ”” <span id="notifCount" class="notif-count">0</span>
          </a>
          
        <!-- Pháº§n hiá»ƒn thá»‹ khi chÆ°a Ä‘Äƒng nháº­p -->
        <div id="auth-buttons">
          <a href="login.html" class="btn-login">ÄÄƒng nháº­p</a>
          <a href="register.html" class="btn-register">ÄÄƒng kÃ½</a>
        </div>

        <!-- Pháº§n hiá»ƒn thá»‹ khi Ä‘Ã£ Ä‘Äƒng nháº­p -->
        <div id="user-section">
          <!-- Icon + Username = clickable link to profile -->
          <a href="profile.html" class="user-profile-link" id="profile-link">
            <i class="fas fa-user-circle user-icon"></i>
            <span id="username-display"></span>
          </a>
          <button id="logout-btn" class="btn-logout">ÄÄƒng xuáº¥t</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- SEARCH -->
  <div class="search-container">
    <div class="search-header">
      <h2>TÃ¬m Resort HoÃ n Háº£o</h2>
      <p>KhÃ¡m phÃ¡ nhá»¯ng ká»³ nghá»‰ tuyá»‡t vá»i</p>
    </div>

    <section class="search-form">
      <label>
        <span>Äá»‹a Ä‘iá»ƒm</span>
        <input type="text" id="location" placeholder="Nháº­p tÃªn Ä‘á»‹a Ä‘iá»ƒm">
      </label>
      <label>
        <span>Loáº¡i phÃ²ng</span>
        <select id="roomType">
          <option value="">Táº¥t cáº£ loáº¡i phÃ²ng</option>
        </select>
      </label>
      <button id="searchBtn" class="search-btn-icon">
        <i class="fas fa-search"></i>
      </button>
    </section>
  </div>

  <!-- MAIN CONTENT -->
  <section class="container">
    <!-- VOUCHERS -->
    <h2 class="section-title">ğŸ« Æ¯u ÄÃ£i Äáº·c Biá»‡t</h2>
    <div id="vouchers-container" class="vouchers-grid"></div>

    <!-- DESTINATIONS -->
    <h2 class="section-title">ğŸ“ Äiá»ƒm Äáº¿n Phá»• Biáº¿n</h2>
    <div id="destinations-container" class="destinations-grid"></div>

    <!-- RESORTS -->
    <div id="room-cards-container"></div>
    <div id="pagination-container" class="pagination"></div>
  </section>

  <!-- WHY CHOOSE US SECTION -->
  <section class="why-choose-us">
    <h2>VÃ¬ sao nÃªn chá»n Resort Booking?</h2>
    <div class="reasons">
      <div class="reason">
        <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Äáº·t phÃ²ng dá»… dÃ ng">
        <h4>Äáº·t chá»— dá»… dÃ ng</h4>
        <p>Chá»‰ vÃ i bÆ°á»›c Ä‘Æ¡n giáº£n Ä‘á»ƒ hoÃ n táº¥t Ä‘áº·t phÃ²ng cá»§a báº¡n.</p>
      </div>
      <div class="reason">
        <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="Æ¯u Ä‘Ã£i háº¥p dáº«n">
        <h4>Æ¯u Ä‘Ã£i háº¥p dáº«n</h4>
        <p>GiÃ¡ tá»‘t nháº¥t má»—i ngÃ y dÃ nh cho khÃ¡ch hÃ ng thÃ¢n thiáº¿t.</p>
      </div>
      <div class="reason">
        <img src="https://cdn-icons-png.flaticon.com/512/906/906334.png" alt="Há»— trá»£ 24/7">
        <h4>Há»— trá»£ 24/7</h4>
        <p>Äá»™i ngÅ© CSKH sáºµn sÃ ng há»— trá»£ báº¡n má»i lÃºc, má»i nÆ¡i.</p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="footer-container">
      <div class="footer-links">
        <a href="#">ChÃ­nh sÃ¡ch báº£o máº­t</a>
        <span>|</span>
        <a href="#">Äiá»u khoáº£n sá»­ dá»¥ng</a>
        <span>|</span>
        <a href="#">LiÃªn há»‡</a>
      </div>
      <div class="footer-social">
        <p>Theo dÃµi chÃºng tÃ´i</p>
        <div class="social-icons">
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733558.png" alt="Instagram"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/2504/2504989.png" alt="Telegram"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/3046/3046126.png" alt="TikTok"></a>
        </div>
      </div>
      <p>&copy; 2025 <span>Resort Booking</span>. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
  
  <script>
    let API_BASE; // DÃ¹ng 'let' thay vÃ¬ 'const'
    
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      // 1. MÃ”I TRÆ¯á»œNG LOCAL
      // (Khi báº¡n cháº¡y file .html tá»« mÃ¡y cá»§a báº¡n)
      API_BASE = 'http://localhost:5500'; // ÄÃ¢y lÃ  backend server.js trÃªn mÃ¡y cá»§a báº¡n
    } else {
      // 2. MÃ”I TRÆ¯á»œNG PRODUCTION
      // (Khi báº¡n Ä‘Ã£ deploy code lÃªn máº¡ng)
      API_BASE = 'https://api-resort.onrender.com'; // ÄÃ¢y lÃ  backend trÃªn OnRender
    }
    // ===== AUTH MANAGEMENT (NEW) =====
    function updateNavbar() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');

      const authButtons = document.getElementById('auth-buttons');
      const userSection = document.getElementById('user-section');
      const usernameDisplay = document.getElementById('username-display');

      if (token && username) {
        if (authButtons) authButtons.classList.add('hidden');
        if (userSection) {
          userSection.classList.add('active');
          if (usernameDisplay) usernameDisplay.textContent = username;
        }
      } else {
        if (authButtons) authButtons.classList.remove('hidden');
        if (userSection) userSection.classList.remove('active');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      updateNavbar();
      window.location.href = '/';
    }

   <!-- ...existing code... -->

      // ===== ORIGINAL CODE (KEPT INTACT) =====
      document.addEventListener('DOMContentLoaded', async () => {
        // Update navbar khi trang load
        updateNavbar();

        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
          });
        }

        let allRooms = [];
        let currentPage = 1;
        const itemsPerPage = 6;
        const PLACEHOLDER_SVG = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22%3ENo Image%3C/text%3E%3C/svg%3E';

        // âœ… FIX: Xá»­ lÃ½ Ä‘Ãºng URL áº£nh
        function resolveImageUrl(url) {
          if (!url) return PLACEHOLDER_SVG;
          
          // Náº¿u lÃ  full URL (http:// hoáº·c https://)
          if (/^https?:\/\//i.test(url)) return url;
          
          // Náº¿u Ä‘Ã£ cÃ³ '/uploads/' thÃ¬ khÃ´ng thÃªm ná»¯a
          if (url.startsWith('/uploads/')) return API_BASE + url;
          
          // NgÆ°á»£c láº¡i thÃªm '/uploads/'
          return API_BASE + '/uploads/' + url;
        }

        function formatPrice(price) {
          return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
          }).format(price);
        }

        function getLocationName(key) {
          const map = {
            'da-lat': 'ÄÃ  Láº¡t',
            'ha-long': 'Háº¡ Long',
            'phu-quoc': 'PhÃº Quá»‘c',
            'nha-trang': 'Nha Trang',
            'da-nang': 'ÄÃ  Náºµng',
            'sapa': 'Sapa',
            'hoi-an': 'Há»™i An',
            'ha-noi': 'HÃ  Ná»™i'
          };
          return map[key] || key || 'ChÆ°a xÃ¡c Ä‘á»‹nh';
        }

        // ===== FETCH VOUCHERS =====
        async function fetchVouchers() {
          try {
            const response = await fetch(`${API_BASE}/api/discounts`);
            if (response.ok) {
              const vouchers = await response.json();
              renderVouchers(vouchers);
            }
          } catch (error) {
            console.log('Vouchers API not available');
          }
        }

        function renderVouchers(vouchers) {
          const container = document.getElementById('vouchers-container');
          container.innerHTML = '';

          if (!vouchers || vouchers.length === 0) return;

          vouchers.slice(0, 4).forEach(voucher => {
            const card = document.createElement('div');
            card.className = 'voucher-card';
            
            const validUntil = new Date(voucher.valid_until).toLocaleDateString('vi-VN');
            const discountText = voucher.discount_type === 'percentage' 
              ? `Giáº£m ${voucher.value}%` 
              : `Giáº£m ${voucher.value}Ä‘`;
            
            card.innerHTML = `
              <div class="voucher-code">${voucher.code}</div>
              <h3>${voucher.name}</h3>
              <p>${voucher.description}</p>
              <p style="margin-top: 8px; font-size: 13px; color: #667eea; font-weight: 600;">${discountText}</p>
              <div class="voucher-expire">Háº¡n: ${validUntil}</div>
            `;
            container.appendChild(card);
          });
        }

        // ===== EXTRACT & RENDER DESTINATIONS =====
        function renderDestinations(rooms) {
          const container = document.getElementById('destinations-container');
          container.innerHTML = '';

          const locations = [...new Set(rooms.map(r => r.location))];
          const locationMap = {
            'da-lat': 'ÄÃ  Láº¡t',
            'ha-long': 'Háº¡ Long',
            'phu-quoc': 'PhÃº Quá»‘c',
            'nha-trang': 'Nha Trang',
            'da-nang': 'ÄÃ  Náºµng',
            'sapa': 'Sapa',
            'hoi-an': 'Há»™i An',
            'ha-noi': 'HÃ  Ná»™i'
          };

          locations.forEach(loc => {
            if (!loc) return;
            const card = document.createElement('a');
            card.className = 'destination-card';
            card.href = `destinations.html?location=${loc}`;

            const imgUrls = {
              'da-lat': 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&h=150&fit=crop',
              'ha-long': 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=300&h=150&fit=crop',
              'phu-quoc': 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=300&h=150&fit=crop',
              'nha-trang': 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=300&h=150&fit=crop',
              'da-nang': 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=300&h=150&fit=crop',
              'sapa': 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&h=150&fit=crop',
              'hoi-an': 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=300&h=150&fit=crop',
              'ha-noi': 'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?w=300&h=150&fit=crop'
            };

            card.innerHTML = `
              <div class="destination-card-image">
                <img src="${imgUrls[loc] || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22150%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22300%22 height=%22150%22/%3E%3C/svg%3E'}" alt="${locationMap[loc] || loc}">
              </div>
              <div class="destination-card-name">${locationMap[loc] || loc}</div>
            `;
            container.appendChild(card);
          });
        }

        // ===== GROUP ROOMS BY RESORT =====
        function groupRoomsByResort(rooms) {
          const grouped = {};
          rooms.forEach(room => {
            const resort = room.resort_name || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
            if (!grouped[resort]) grouped[resort] = [];
            grouped[resort].push(room);
          });
          return grouped;
        }

        // ===== RENDER ROOMS =====
        function renderRooms(roomsToDisplay) {
          const container = document.getElementById('room-cards-container');
          container.innerHTML = '';

          if (!roomsToDisplay || roomsToDisplay.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:40px; color:#718096;">KhÃ´ng tÃ¬m tháº¥y phÃ²ng phÃ¹ há»£p</p>';
            return;
          }

          const grouped = groupRoomsByResort(roomsToDisplay);

          Object.entries(grouped).forEach(([resortName, rooms]) => {
            const title = document.createElement('h3');
            title.className = 'resort-group-title';
            title.textContent = `ğŸ¨ ${resortName}`;
            container.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'rooms-grid';

            rooms.forEach(room => {
              const card = document.createElement('div');
              card.className = 'room-card';
              card.style.cursor = 'pointer';
              card.onclick = () => window.location.href = `resort_detail.html?id=${room.id}`;

             // âœ… Sá»¬A Lá»–I HIá»‚N THá»Š áº¢NH (Xá»­ lÃ½ chuá»—i PostgreSQL)
Â  Â  Â  Â  Â  Â  Â  let imageName = null; // TÃªn file sáº¡ch

Â  Â  Â  Â  Â  Â  Â  if (room.images && Array.isArray(room.images) && room.images.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // TrÆ°á»ng há»£p 1: Dá»¯ liá»‡u sáº¡ch (Ä‘Ã£ sá»­a á»Ÿ admin) -> ["file.jpg"]
Â  Â  Â  Â  Â  Â  Â  Â  imageName = room.images[0];
Â  Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  Â  else if (room.images && typeof room.images === 'string' && room.images.startsWith('{')) {
Â  Â  Â  Â  Â  Â  Â  Â  // TrÆ°á»ng há»£p 2: Dá»¯ liá»‡u chuá»—i PostgreSQL -> "{\"file.jpg\",\"file2.jpg\"}"
                // ChÃºng ta sáº½ láº¥y tÃªn file Ä‘áº§u tiÃªn
Â  Â  Â  Â  Â  Â  Â  Â  const firstImage = room.images.replace(/[{}"\\]/g, '').split(',')[0];
Â  Â  Â  Â  Â  Â  Â  Â  imageName = firstImage;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  // Chá»‰ gá»i resolveImageUrl vá»›i tÃªn file sáº¡ch (hoáº·c null)
Â  Â  Â  Â  Â  Â  Â  const imageUrl = resolveImageUrl(imageName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-card-image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${imageUrl}" alt="${room.room_type}" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onerror="this.src='${PLACEHOLDER_SVG}'">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-card-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>${room.room_type}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><i class="fas fa-map-marker-alt"></i> ${getLocationName(room.location)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><i class="fas fa-door-open"></i> ${room.num_bed || 'ChÆ°a xÃ¡c Ä‘á»‹nh'} giÆ°á»ng</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-price">${formatPrice(room.price_per_night)}/Ä‘Ãªm</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  container.appendChild(grid);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
        // ===== FETCH DATA =====
        async function fetchRooms() {
          try {
            const response = await fetch(`${API_BASE}/api/rooms`);
            if (!response.ok) throw new Error('Network error');
            allRooms = await response.json();
            
            // ğŸ“ DEBUG: Log dá»¯ liá»‡u tráº£ vá»
            console.log('âœ… Rooms fetched:', allRooms);
            console.log('First room images:', allRooms[0]?.images);
            
            populateRoomTypes();
            renderDestinations(allRooms);
          } catch (error) {
            console.error('Error:', error);
            allRooms = [];
          }
        }

        function populateRoomTypes() {
          const select = document.getElementById('roomType');
          const types = [...new Set(allRooms.map(r => r.room_type))];
          types.forEach(type => {
            if (type) {
              const opt = document.createElement('option');
              opt.value = type;
              opt.textContent = type;
              select.appendChild(opt);
            }
          });
        }

        // ===== PAGINATION =====
        function renderPagination() {
          const container = document.getElementById('pagination-container');
          container.innerHTML = '';
          const total = Math.ceil(allRooms.length / itemsPerPage);

          if (total <= 1) return;

          for (let i = 1; i <= total; i++) {
            const btn = document.createElement('button');
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => {
              currentPage = i;
              const start = (i - 1) * itemsPerPage;
              renderRooms(allRooms.slice(start, start + itemsPerPage));
              renderPagination();
              window.scrollTo({ top: 300, behavior: 'smooth' });
            };
            container.appendChild(btn);
          }
        }

        function renderCurrentPage() {
          const start = (currentPage - 1) * itemsPerPage;
          renderRooms(allRooms.slice(start, start + itemsPerPage));
        }

        // ===== SEARCH =====
        document.getElementById('searchBtn').onclick = () => {
          const location = document.getElementById('location').value.toLowerCase();
          const type = document.getElementById('roomType').value;

          const filtered = allRooms.filter(room => {
            const matchLoc = !location || 
                            getLocationName(room.location).toLowerCase().includes(location) ||
                            (room.resort_name && room.resort_name.toLowerCase().includes(location));
            const matchType = !type || room.room_type === type;
            return matchLoc && matchType;
          });

          document.getElementById('pagination-container').innerHTML = '';
          renderRooms(filtered);
        };

        // ===== INIT =====
        await fetchRooms();
        await fetchVouchers();
        renderCurrentPage();
        renderPagination();
      });
  </script>

    <!-- Notifications Script -->
  <script>
    // Láº¥y pháº§n tá»­ hiá»ƒn thá»‹ sá»‘ thÃ´ng bÃ¡o chÆ°a Ä‘á»c
    const notifCount = document.getElementById("notifCount");

    // HÃ m load thÃ´ng bÃ¡o (chá»‰ cáº­p nháº­t sá»‘ lÆ°á»£ng chÆ°a Ä‘á»c)
    async function loadNotifications() {
      try {
        const token = localStorage.getItem("token"); // náº¿u cáº§n xÃ¡c thá»±c

        // Gá»i API (nÃªn dÃ¹ng endpoint chá»‰ tráº£ vá» sá»‘ lÆ°á»£ng náº¿u cÃ³)
        const res = await fetch(`${API_BASE}/notifications?limit=1`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();

        // Cáº­p nháº­t sá»‘ thÃ´ng bÃ¡o chÆ°a Ä‘á»c
        notifCount.textContent = data.unreadCount || 0;

      } catch (err) {
        console.error("Lá»—i load notifications:", err);
      }
    }

    // Gá»i ngay khi má»Ÿ trang
    loadNotifications();

    // Tá»± Ä‘á»™ng refresh má»—i 60 giÃ¢y
    setInterval(loadNotifications, 60000);
  </script>

</body>
</html>