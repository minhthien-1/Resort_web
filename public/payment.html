<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .payment-method {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method:hover {
            border-color: #5B4C9F;
            background-color: #f9f7ff;
        }
        
        .payment-method input[type="radio"] {
            margin-right: 12px;
        }
        
        .payment-method.selected {
            border-color: #5B4C9F;
            background-color: #f0ecff;
        }
        
        .payment-method label {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            margin: 0;
        }
        
        .payment-method-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto p-4 lg:p-8">
        <div class="bg-blue-500 text-white p-3 rounded-lg flex justify-between items-center mb-6">
            <span class="font-semibold">ƒê·ª´ng lo l·∫Øng, gi√° v·∫´n gi·ªØ nguy√™n. Ho√†n t·∫•t thanh to√°n c·ªßa b·∫°n trong <span id="countdown" class="font-bold">10:00</span></span>
            <span class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center"><i class="fas fa-check text-xs"></i></span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm">
                <h2 class="text-2xl font-bold mb-6">B·∫°n mu·ªën thanh to√°n th·∫ø n√†o?</h2>
                
                <!-- ===== PAYMENT METHODS ===== -->
                <div class="space-y-4">
                    <!-- VNPay Payment -->
                    <div class="payment-method" id="vnpay-method">
                        <input type="radio" name="payment" id="vnpay" value="vnpay" checked>
                        <label for="vnpay">
                            <div class="payment-method-icon">
                                <i class="fas fa-credit-card" style="color: #1f1f1f;"></i>
                            </div>
                            <div>
                                <p class="font-bold text-lg">VNPay</p>
                                <p class="text-sm text-gray-500">Thanh to√°n tr·ª±c tuy·∫øn qua VNPay</p>
                            </div>
                        </label>
                    </div>

                    <!-- Direct Payment -->
                    <div class="payment-method" id="direct-method">
                        <input type="radio" name="payment" id="direct" value="direct">
                        <label for="direct">
                            <div class="payment-method-icon">
                                <i class="fas fa-money-bill" style="color: #10b981;"></i>
                            </div>
                            <div>
                                <p class="font-bold text-lg">Thanh To√°n T·∫°i Qu·∫ßy</p>
                                <p class="text-sm text-gray-500">Thanh to√°n khi nh·∫≠n ph√≤ng</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t flex justify-between items-center">
                    <span class="font-semibold text-lg">T·ªïng gi√° ti·ªÅn</span>
                    <span id="total-price" class="font-bold text-2xl text-red-600">0 VND</span>
                </div>
                <div class="mt-6">
                    <button id="confirm-payment-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg py-3 rounded-lg transition">
                        Thanh to√°n ngay
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1">
                 <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200">
                    <h3 class="text-xl font-bold mb-4">T√≥m t·∫Øt kh√°ch s·∫°n</h3>
                    <p class="text-sm text-gray-600 mb-4">M√£ ƒë·∫∑t ch·ªó <span id="booking-code">...</span></p>
                    <h4 id="summary-resort-name" class="font-bold text-lg mb-2">T√™n kh√°ch s·∫°n...</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div>
                            <label class="font-semibold">Nh·∫≠n ph√≤ng</label>
                            <p id="summary-checkin-date">...</p>
                            <p class="text-gray-500">T·ª´ 12:00</p>
                        </div>
                         <div>
                            <label class="font-semibold">Tr·∫£ ph√≤ng</label>
                            <p id="summary-checkout-date">...</p>
                            <p class="text-gray-500">Tr∆∞·ªõc 12:00</p>
                        </div>
                    </div>
                    <div class="border-t border-b border-gray-300 py-4 mb-4">
                        <p id="summary-room-type" class="font-semibold mb-2">Chi ti·∫øt ph√≤ng...</p>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p><i class="fas fa-users w-5"></i> <span id="summary-capacity">...</span> kh√°ch</p>
                            <p><i class="fas fa-wifi w-5"></i> WiFi mi·ªÖn ph√≠</p>
                        </div>
                    </div>
                    <div class="border-b border-gray-300 pb-4 mb-4">
                        <p class="font-semibold mb-2">T√™n kh√°ch</p>
                        <p id="summary-guest-name" class="text-sm text-gray-700">...</p>
                        <div class="flex items-center text-green-600 text-sm mt-2">
                            <i class="fas fa-check-circle mr-2"></i><span>Mi·ªÖn ph√≠ h·ªßy ph√≤ng</span>
                        </div>
                        <div class="flex items-center text-green-600 text-sm mt-1">
                            <i class="fas fa-check-circle mr-2"></i><span>C√≥ th·ªÉ ƒë·ªïi l·ªãch</span>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">Chi ti·∫øt ng∆∞·ªùi li√™n l·∫°c</p>
                        <p id="summary-contact-name" class="text-sm text-gray-700">...</p>
                        <p id="summary-contact-phone" class="text-sm text-gray-700">...</p>
                        <p id="summary-contact-email" class="text-sm text-gray-700">...</p>
                    </div>
                 </div>
                 <div class="bg-green-300 text-green-800 font-semibold text-center p-3 rounded-lg mt-4">
                    S·ª± l·ª±a ch·ªçn tuy·ªát v·ªùi cho k·ª≥ ngh·ªâ c·ªßa b·∫°n!
                 </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bookingDetailsJSON = sessionStorage.getItem('bookingDetails');
            if (!bookingDetailsJSON) {
                document.body.innerHTML = '<div class="text-center p-10"><h1 class="text-2xl font-bold text-red-600">L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng.</h1><p class="mt-4">Vui l√≤ng quay l·∫°i trang chi ti·∫øt v√† ƒë·∫∑t ph√≤ng.</p><a href="home.html" class="mt-4 inline-block bg-blue-500 text-white px-4 py-2 rounded">V·ªÅ trang ch·ªß</a></div>';
                return;
            }
            
            const booking = JSON.parse(bookingDetailsJSON);
            const parseDate = (str) => { const [day, month, year] = str.split('/'); return new Date(`${year}-${month}-${day}`); };
            const checkInDate = parseDate(booking.checkIn);
            const checkOutDate = parseDate(booking.checkOut);
            const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
            const nights = Math.max(1, Math.ceil(timeDiff / (1000 * 3600 * 24)));
            const totalPrice = nights * booking.pricePerNight;
            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

            // ƒêi·ªÅn th√¥ng tin v√†o trang
            document.getElementById('booking-code').textContent = 'Ch·ªù x√°c nh·∫≠n...';
            document.getElementById('summary-resort-name').textContent = booking.resortName;
            document.getElementById('summary-checkin-date').textContent = booking.checkIn;
            document.getElementById('summary-checkout-date').textContent = booking.checkOut;
            document.getElementById('summary-room-type').textContent = `(1x) ${booking.num_bed || 'Ch∆∞a x√°c ƒë·ªãnh'}`;
            document.getElementById('summary-capacity').textContent = booking.capacity;
            document.getElementById('summary-guest-name').textContent = booking.userFullName;
            document.getElementById('summary-contact-name').textContent = booking.userFullName;
            document.getElementById('summary-contact-phone').textContent = booking.userPhone;
            document.getElementById('summary-contact-email').textContent = booking.userEmail;
            document.getElementById('total-price').textContent = formatCurrency(totalPrice);

            // ===== PAYMENT METHOD SELECTION =====
            const paymentRadios = document.querySelectorAll('input[name="payment"]');
            paymentRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.payment-method').forEach(method => {
                        method.classList.remove('selected');
                    });
                    e.target.closest('.payment-method').classList.add('selected');
                });
            });

            // Set initial selected state
            document.getElementById('vnpay-method').classList.add('selected');

            // ===== PAYMENT BUTTON =====
            const paymentButton = document.getElementById('confirm-payment-btn');
            paymentButton.addEventListener('click', async () => {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    window.location.href = 'login.html';
                    return;
                }

                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

                paymentButton.disabled = true;
                paymentButton.textContent = 'ƒêang x·ª≠ l√Ω...';

                try {
                    if (paymentMethod === 'vnpay') {
                        // VNPay Payment
                        console.log('üîç Booking Data:', booking);
                        console.log('üîç Total Price:', totalPrice);
                        console.log('üîç Token:', token);

                        const bookingResponse = await fetch('https://api-resort.onrender.com/api/bookings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                roomId: booking.resortId,
                                checkIn: booking.checkIn,
                                checkOut: booking.checkOut,
                                pricePerNight: booking.pricePerNight,
                                totalPrice: totalPrice
                            })
                        });

                        console.log('üì° Booking Response Status:', bookingResponse.status);
                        const bookingResult = await bookingResponse.json();
                        console.log('üì° Booking Result:', bookingResult);

                        if (!bookingResponse.ok) {
                            throw new Error(bookingResult.error || `API Error: ${bookingResponse.status}`);
                        }

                        const bookingId = bookingResult.booking?.id || bookingResult.booking?.booking_code;
                        console.log('‚úÖ Booking ID:', bookingId);

                        // T·∫°o URL thanh to√°n VNPay
                        const paymentResponse = await fetch('https://api-resort.onrender.com/api/payments/fake/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                bookingId: bookingId,
                                amount: totalPrice,
                                orderInfo: `Thanh to√°n booking #${bookingId}`,
                                userFullName: booking.userFullName
                            })
                        });

                        const paymentData = await paymentResponse.json();

                        if (!paymentResponse.ok) {
                            throw new Error(paymentData.error || 'T·∫°o URL thanh to√°n th·∫•t b·∫°i');
                        }

                        // Redirect t·ªõi VNPay
                        if (paymentData.paymentUrl) {
                            window.location.href = paymentData.paymentUrl;
                        } else {
                            throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL thanh to√°n');
                        }

                    } else if (paymentMethod === 'direct') {
                        // Direct Payment
                        const response = await fetch('https://api-resort.onrender.com/api/bookings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                roomId: booking.resortId,
                                checkIn: booking.checkIn,
                                checkOut: booking.checkOut,
                                pricePerNight: booking.pricePerNight,
                                totalPrice: totalPrice
                            })
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.');
                        }

                        alert(`‚úÖ ƒê·∫∑t ph√≤ng th√†nh c√¥ng! M√£ ƒë·∫∑t ph√≤ng c·ªßa b·∫°n l√†: ${result.booking.booking_code}\n\nVui l√≤ng thanh to√°n t·∫°i qu·∫ßy khi nh·∫≠n ph√≤ng.`);
                        sessionStorage.removeItem('bookingDetails');
                        window.location.href = 'home.html';
                    }

                } catch (error) {
                    console.error('‚ùå Payment Error:', error);
                    alert(`‚ùå L·ªói: ${error.message}`);
                    paymentButton.disabled = false;
                    paymentButton.textContent = 'Thanh to√°n ngay';
                }
            });

            // Logic ƒë·∫øm ng∆∞·ª£c
            let time = 10 * 60;
            const countdownEl = document.getElementById('countdown');
            setInterval(() => {
                if (time <= 0) {
                    countdownEl.textContent = "00:00";
                    return;
                };
                time--;
                const minutes = String(Math.floor(time / 60)).padStart(2, '0');
                const seconds = String(time % 60).padStart(2, '0');
                countdownEl.textContent = `${minutes}:${seconds}`;
            }, 1000);
        });
    </script>
</body>
</html>