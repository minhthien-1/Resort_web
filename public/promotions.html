<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khuy·∫øn m√£i - Resort Booking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="promotions.css">
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <a href="home.html" style="text-decoration: none;"><h1>Resort Booking</h1></a>
      </div>
      <nav class="navbar-menu">
        <a href="home.html">Trang ch·ªß</a>
        <a href="promotions.html" class="active">Khuy·∫øn m√£i</a>
        <a href="supports/support.html">H·ªó tr·ª£</a>
        <a href="#">H·ª£p t√°c</a>
        <a href="my_bookings.html">ƒê·∫∑t ch·ªó</a>
        
        <!-- Auth buttons -->
        <div id="auth-buttons">
          <a href="login.html" class="btn-login">ƒêƒÉng nh·∫≠p</a>
          <a href="register.html" class="btn-register">ƒêƒÉng k√Ω</a>
        </div>

        <!-- User section -->
        <div id="user-section">
          <a href="profile.html" class="user-profile-link">
            <i class="fas fa-user-circle user-icon"></i>
            <span id="username-display"></span>
          </a>
          <button id="logout-btn" class="btn-logout">ƒêƒÉng xu·∫•t</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- BANNER -->
  <section class="promo-banner">
    <div class="banner-content">
      <h2>üéâ Khuy·∫øn m√£i h·∫•p d·∫´n d√†nh ri√™ng cho b·∫°n</h2>
      <p>Ti·∫øt ki·ªám nhi·ªÅu h∆°n khi ƒë·∫∑t ph√≤ng c√πng Resort Booking</p>
    </div>
  </section>

  <!-- FILTER -->
  <section class="promo-filter">
    <div class="filter-container">
      <input type="text" id="searchInput" placeholder="T√¨m khuy·∫øn m√£i theo m√£ ho·∫∑c t√™n...">
      <select id="filterType">
        <option value="">T·∫•t c·∫£</option>
        <option value="percentage">Gi·∫£m theo %</option>
        <option value="fixed">Gi·∫£m c·ªë ƒë·ªãnh</option>
      </select>
      <button class="filter-btn" id="searchBtn">
        <i class="fas fa-search"></i> T√¨m ki·∫øm
      </button>
    </div>
  </section>

  <!-- VOUCHERS LIST -->
  <section class="promo-list" id="promo-container">
    <div class="loading">
      <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i khuy·∫øn m√£i...
    </div>
  </section>

  <!-- EMPTY STATE -->
  <div class="empty-state" id="empty-state" style="display: none;">
    <i class="fas fa-gift"></i>
    <h3>Kh√¥ng t√¨m th·∫•y khuy·∫øn m√£i</h3>
    <p>H√£y th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c</p>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-container">
      <div class="footer-links">
        <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
        <span>|</span>
        <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
        <span>|</span>
        <a href="supports/support.html">Li√™n h·ªá</a>
      </div>
      <div class="footer-social">
        <p>Theo d√µi ch√∫ng t√¥i</p>
        <div class="social-icons">
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733558.png" alt="Instagram"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/2504/2504989.png" alt="Telegram"></a>
          <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/3046/3046126.png" alt="TikTok"></a>
        </div>
      </div>
      <p>&copy; 2025 <span>Resort Booking</span>. All rights reserved.</p>
    </div>
  </footer>

  <script>
    const API_BASE = 'https://api-resort.onrender.com';

    let allVouchers = [];

    // Auth management
    function updateNavbar() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');
      const authButtons = document.getElementById('auth-buttons');
      const userSection = document.getElementById('user-section');
      const usernameDisplay = document.getElementById('username-display');

      if (token && username) {
        authButtons.classList.add('hidden');
        userSection.classList.add('active');
        usernameDisplay.textContent = username;
      } else {
        authButtons.classList.remove('hidden');
        userSection.classList.remove('active');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      updateNavbar();
      window.location.href = 'home.html';
    }

    // Fetch vouchers from API
    async function fetchVouchers() {
      const container = document.getElementById('promo-container');
      const emptyState = document.getElementById('empty-state');
      
      try {
        const response = await fetch(`${API_BASE}/api/discounts`);
        if (!response.ok) throw new Error('Failed to fetch');
        
        allVouchers = await response.json();
        renderVouchers(allVouchers);
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i> Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu khuy·∫øn m√£i</div>';
      }
    }

    function renderVouchers(vouchers) {
      const container = document.getElementById('promo-container');
      const emptyState = document.getElementById('empty-state');
      
      container.innerHTML = '';
      
      if (!vouchers || vouchers.length === 0) {
        emptyState.style.display = 'flex';
        return;
      }
      
      emptyState.style.display = 'none';
      
      vouchers.forEach(voucher => {
        const validUntil = new Date(voucher.valid_until).toLocaleDateString('vi-VN');
        const discountText = voucher.discount_type === 'percentage' 
          ? `Gi·∫£m ${voucher.value}%` 
          : `Gi·∫£m ${voucher.value.toLocaleString('vi-VN')}ƒë`;
        
        const card = document.createElement('div');
        card.className = 'promo-card';
        card.innerHTML = `
          <div class="promo-badge">${discountText}</div>
          <div class="promo-content">
            <div class="voucher-code">${voucher.code}</div>
            <h3>${voucher.name}</h3>
            <p class="promo-desc">${voucher.description || '∆Øu ƒë√£i ƒë·∫∑c bi·ªát'}</p>
            <div class="promo-footer">
              <span class="promo-expire"><i class="far fa-calendar"></i> H·∫°n: ${validUntil}</span>
              <button class="copy-btn" onclick="copyCode('${voucher.code}')">
                <i class="far fa-copy"></i> Sao ch√©p
              </button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        alert(`ƒê√£ sao ch√©p m√£: ${code}`);
      }).catch(err => {
        console.error('Error:', err);
      });
    }

    function filterVouchers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filterType = document.getElementById('filterType').value;
      
      let filtered = allVouchers.filter(v => {
        const matchSearch = !searchTerm || 
                          v.code.toLowerCase().includes(searchTerm) ||
                          v.name.toLowerCase().includes(searchTerm) ||
                          (v.description && v.description.toLowerCase().includes(searchTerm));
        const matchType = !filterType || v.discount_type === filterType;
        return matchSearch && matchType;
      });
      
      renderVouchers(filtered);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      updateNavbar();
      fetchVouchers();
      
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          logout();
        });
      }
      
      document.getElementById('searchBtn').addEventListener('click', filterVouchers);
      document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') filterVouchers();
      });
      document.getElementById('filterType').addEventListener('change', filterVouchers);
    });
  </script>
</body>
</html>