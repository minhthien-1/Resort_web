<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Qu·∫£n L√Ω Resort & Ph√≤ng - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f5f7fa; color:#374151; }
        .card{background:#fff;border-radius:12px;padding:1.25rem;box-shadow:0 6px 16px rgba(0,0,0,.06)}
        .btn-primary{background:linear-gradient(90deg,#3b82f6,#2563eb);color:#fff;padding:.5rem 1rem;border-radius:10px;transition:all 0.3s}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.4)}
        .btn-secondary{background-color: #e5e7eb; color: #374151; padding: .5rem 1rem; border-radius: 10px; font-weight: 500; transition: all 0.3s;}
        .btn-secondary:hover{background-color: #d1d5db;}
        #room-modal .modal-card{ width:100%; max-width:620px; border-radius:14px; padding:26px; background:#fff; box-shadow:0 12px 40px rgba(2,6,23,.3); max-height: 90vh; overflow-y: auto; }
        .image-preview-item{position:relative;width:60px;height:60px;border-radius:8px;overflow:hidden;margin-right:8px;margin-top: 8px;}
        .image-preview-item img{width:100%;height:100%;object-fit:cover}
        .image-preview-item .remove-image{position:absolute;top:2px;right:2px;background:rgba(239,68,68,.9);color:#fff;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;font-weight:bold}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
        .form-row.full{grid-template-columns:1fr}
        .table-responsive{overflow-x:auto}
        .price-badge{background:#e0f2fe;color:#0369a1;padding:0.25rem 0.75rem;border-radius:9999px;font-weight:600;font-size:0.875rem}
        .status-badge{padding:0.25rem 0.75rem;border-radius:9999px;font-weight:600;font-size:0.875rem}
        .error-message{color:#dc2626;font-size:0.875rem;margin-top:0.5rem}
        .success-message{color:#059669;font-size:0.875rem;margin-top:0.5rem}
        .bed-input-hint{color:#6b7280;font-size:0.75rem;margin-top:0.25rem}
        input[type="text"].bed-input{font-size:0.95rem}
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <button onclick="window.history.back()" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-600 transition-colors" aria-label="Quay l·∫°i trang tr∆∞·ªõc">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-2xl font-bold">üè® Qu·∫£n L√Ω Resort & Ph√≤ng</h1>
            </div>
            <button class="btn-primary" onclick="openNewResortModal()">+ T·∫°o Resort M·ªõi</button>
        </div>
        <div id="resorts-list-container" class="space-y-6">
             <p id="list-message" class="text-center mt-6 text-sm text-gray-500">ƒêang t·∫£i danh s√°ch resort...</p>
        </div>
    </div>

    <!-- Modal Th√™m/S·ª≠a Ph√≤ng -->
    <div id="room-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4">
        <div class="modal-card">
            <h3 id="modal-title" class="text-xl font-semibold mb-4">Th√™m Ph√≤ng M·ªõi</h3>
            <form id="room-form">
                <input type="hidden" id="room-id" />
                <input type="hidden" id="resort-id" />
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Lo·∫°i ph√≤ng</label>
                    <select id="room-type-id" class="w-full border rounded px-3 py-2" required></select>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Gi√° m·ªói ƒë√™m (VND)</label>
                        <input id="room-price" type="number" min="0" class="w-full border rounded px-3 py-2" placeholder="V√≠ d·ª•: 1500000" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Lo·∫°i h√¨nh l∆∞u tr√∫</label>
                        <select id="room-category" class="w-full border rounded px-3 py-2">
                            <option value="standard">Kh√°ch s·∫°n/Ti√™u chu·∫©n</option>
                            <option value="apartment">CƒÉn h·ªô</option>
                            <option value="villa">Bi·ªát th·ª±</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">C·∫•u h√¨nh gi∆∞·ªùng</label>
                        <select id="num-bed" class="w-full border rounded px-3 py-2">
                            <option value="1 gi∆∞·ªùng ƒë∆°n">1 Gi∆∞·ªùng ƒê∆°n</option>
                            <option value="1 gi∆∞·ªùng ƒë√¥i">1 Gi∆∞·ªùng ƒê√¥i</option>
                            <option value="2 gi∆∞·ªùng ƒë∆°n">2 Gi∆∞·ªùng ƒê∆°n</option>
                            <option value="2 gi∆∞·ªùng ƒë√¥i">2 Gi∆∞·ªùng ƒê√¥i</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium mb-1">Tr·∫°ng th√°i</label>
                        <select id="room-status" class="w-full border rounded px-3 py-2">
                            <option value="available">S·∫µn c√≥</option>
                            <option value="maintenance">B·∫£o tr√¨</option>
                        </select>
                    </div>
                </div>
               
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">H√¨nh ·∫£nh ph√≤ng</label>
                    <input id="room-images" type="file" accept="image/*" multiple class="w-full" />
                    <p class="text-xs text-gray-500 mt-1">C√°c ·∫£nh xem tr∆∞·ªõc (m·ªõi) b√™n d∆∞·ªõi. Khi s·ª≠a, upload ·∫£nh m·ªõi s·∫Ω **thay th·∫ø to√†n b·ªô** ·∫£nh c≈©.</p>
                    <div id="image-preview" class="flex flex-wrap mt-2"></div>
                </div>

                <!-- H√†ng 4: V·ªã tr√≠ & ƒê·ªãa ch·ªâ -->
                <div class="form-row">
                    <div>
                        <label class="block text-sm font-medium mb-1">V·ªã tr√≠ *</label>
                        <select id="room-location" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" required>
                            <option value="">-- Ch·ªçn v·ªã tr√≠ --</option>
                            <option value="da-lat">üìç ƒê√† L·∫°t</option>
                            <option value="ha-long">üìç H·∫° Long</option>
                            <option value="phu-quoc">üìç Ph√∫ Qu·ªëc</option>
                            <option value="nha-trang">üìç Nha Trang</option>
                            <option value="da-nang">üìç ƒê√† N·∫µng</option>
                            <option value="sapa">üìç Sapa</option>
                            <option value="hoi-an">üìç H·ªôi An</option>
                            <option value="ha-noi">üìç H√† N·ªôi</option>
                            <option value="sai-gon">üìç S√†i G√≤n</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                        <input id="room-address" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="Khu A, Ph∆∞·ªùng X..." />
                    </div>
                </div>

                <!-- H√†ng 5: Th√¥ng tin chi ti·∫øt -->
                <div class="form-row full">
                    <div>
                        <label class="block text-sm font-medium mb-1">Th√¥ng tin chi ti·∫øt</label>
                        <textarea id="room-description" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="M√¥ t·∫£ v·ªÅ ph√≤ng, c√°c ti·ªán √≠ch ƒë·∫∑c bi·ªát..."></textarea>
                    </div>
                </div>

                <!-- H√†ng 6: H√¨nh ·∫£nh -->
                <div class="form-row full">
                    <div>
                        <label class="block text-sm font-medium mb-1">H√¨nh ·∫£nh ph√≤ng</label>
                        <input id="room-images" type="file" accept="image/*" multiple class="w-full border border-gray-300 rounded px-3 py-2" />
                        <div id="image-preview" class="flex flex-wrap mt-2"></div>
                    </div>
                </div>

                <!-- N√∫t h√†nh ƒë·ªông -->
                <div class="flex justify-end items-center space-x-3 mt-6">
                    <button type="button" onclick="closeRoomModal()" class="btn-secondary">‚ùå H·ªßy</button>
                    <button type="submit" id="modal-submit-btn" class="btn-primary">‚úÖ Th√™m Ph√≤ng</button>
                </div>
                <p id="modal-error-message" class="error-message"></p>
                <p id="modal-success-message" class="success-message"></p>
            </form>
        </div>
    </div>

    <script>
    const API_BASE = "http://localhost:5500";
    let ALL_ROOMS = [];
    let ROOM_TYPES = [];
    let currentMode = 'create'; 

    function formatCurrency(value) {
        if (!value || isNaN(value)) return '-';
        const numValue = parseFloat(value);
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(numValue);
    }

    async function apiFetch(url, opts = {}) {
        const token = localStorage.getItem("token");
        const headers = { "Authorization": `Bearer ${token}` };
        if (!(opts.body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
        }
        const res = await fetch(API_BASE + url, { ...opts, headers });
        if (res.status === 204 || res.status === 201) return null;
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || data.error || `HTTP Error ${res.status}`);
        return data;
    }
    
    async function fetchAndRenderAll() {
        const container = document.getElementById('resorts-list-container');
        container.innerHTML = `<p class="text-center text-gray-500">ƒêang t·∫£i danh s√°ch...</p>`;
        try {
            const [resorts, rooms] = await Promise.all([
                apiFetch('/api/admin/resorts'),
                apiFetch('/api/admin/rooms')
            ]);
            
            ALL_ROOMS = rooms; 
            container.innerHTML = '';
            if (!resorts.length) {
                container.innerHTML = `<p class="text-center text-gray-500">Ch∆∞a c√≥ resort n√†o. H√£y t·∫°o m·ªôt resort m·ªõi!</p>`;
                return;
            }
            resorts.forEach(resort => {
                const resortRooms = rooms.filter(room => room.resort_id === resort.id);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üè® ${resort.name}</h2>
                        <button class="btn-primary" onclick="openRoomModal('create', ${resort.id})">+ Th√™m ph√≤ng</button>
                    </div>
                    <div class="table-responsive">
                        <table class="w-full text-sm">
                            <thead><tr class="text-left text-gray-500"><th class="p-2">H·∫°ng ph√≤ng</th><th class="p-2">Gi√°</th><th class="p-2">S·ªë gi∆∞·ªùng</th><th class="p-2">Tr·∫°ng th√°i</th><th class="p-2">Thao t√°c</th></tr></thead>
                            <tbody>
                                ${resortRooms.length ? resortRooms.map(room => `
                                    <tr class="border-t">
                                        <td class="p-2 font-medium">${room.room_type}</td>
                                        <td class="p-2">${formatCurrency(room.price_per_night)}</td> 
                                        <td class="p-2">${room.num_bed || '-'}</td>
                                        <td class="p-2">${room.status}</td>
                                        <td class="p-2">
                                            <button class="text-blue-600 hover:underline" onclick='openRoomModal("edit", ${room.resort_id}, "${room.id}")'>S·ª≠a</button>
                                            <button class="text-red-600 hover:underline ml-2" onclick="deleteRoom('${room.id}')">X√≥a</button>
                                        </td>
                                    </tr>
                                `).join('') : `<tr><td colspan="5" class="text-center p-4 text-gray-500">Resort n√†y ch∆∞a c√≥ ph√≤ng.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            container.innerHTML = `<p class="text-center text-red-500">‚ùå L·ªói: ${error.message}</p>`;
        }
    }

    async function openNewResortModal() {
        const resortName = prompt("Nh·∫≠p t√™n resort m·ªõi:");
        if (resortName && resortName.trim() !== "") {
            try {
                await apiFetch('/api/admin/resorts', { method: 'POST', body: JSON.stringify({ name: resortName }) });
                fetchAndRenderAll();
                alert("‚úÖ T·∫°o resort th√†nh c√¥ng!");
            } catch (error) { 
                alert(`‚ùå L·ªói: ${error.message}`); 
            }
        }
    }

    function openRoomModal(mode, resortId, roomId = null) {
        currentMode = mode;
        const modal = document.getElementById('room-modal');
        const form = document.getElementById('room-form');
        form.reset();
        
        // Lu√¥n lu√¥n d·ªçn d·∫πp preview khi m·ªü modal
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        
        document.getElementById('modal-error-message').textContent = '';
        document.getElementById('modal-success-message').textContent = '';
        
        if (mode === 'create') {
            document.getElementById('modal-title').textContent = '‚ûï Th√™m Ph√≤ng M·ªõi';
            document.getElementById('modal-submit-btn').textContent = '‚úÖ Th√™m Ph√≤ng';
            document.getElementById('room-id').value = '';
            document.getElementById('resort-id').value = resortId;
        } else if (mode === 'edit' && roomId) { 
            
            const roomData = ALL_ROOMS.find(room => room.id == roomId); 
            if (!roomData) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√≤ng!");
                return;
            }

            document.getElementById('modal-title').textContent = `S·ª≠a Ph√≤ng: ${roomData.room_type}`;
            document.getElementById('modal-submit-btn').textContent = 'L∆∞u Thay ƒê·ªïi';
            document.getElementById('room-id').value = roomData.id;
            document.getElementById('resort-id').value = resortId;
            document.getElementById('room-type-id').value = roomData.room_type_id;
            document.getElementById('room-category').value = roomData.category;
            document.getElementById('num-bed').value = roomData.num_bed;
            document.getElementById('room-status').value = roomData.status;
            document.getElementById('room-price').value = roomData.price_per_night || '';
            document.getElementById('room-location').value = roomData.location;
            document.getElementById('room-address').value = roomData.address || '';
            document.getElementById('room-description').value = roomData.description || '';

            // ===== üìç THAY ƒê·ªîI 2: HI·ªÇN TH·ªä ·∫¢NH C≈® =====
            // Backend tr·∫£ v·ªÅ `images` (l√† `images_url` trong DB)
            if (roomData.images && Array.isArray(roomData.images)) {
                roomData.images.forEach(imageName => {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    // Backend c·ªßa b·∫°n ph·ª•c v·ª• file t·ª´ /uploads
                    div.innerHTML = `<img src="/uploads/${imageName}" alt="·∫¢nh hi·ªán t·∫°i">`;
                    preview.appendChild(div);
                });
            }
            // ==============================================
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeRoomModal() {
        document.getElementById('room-modal').classList.add('hidden');
    }
    
    document.getElementById('room-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('modal-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
        
        const roomId = document.getElementById('room-id').value;
        const fd = new FormData();
        fd.append('resort_id', document.getElementById('resort-id').value);
        fd.append('room_type_id', document.getElementById('room-type-id').value);
        fd.append('category', document.getElementById('room-category').value);
        fd.append('num_bed', document.getElementById('num-bed').value.trim());
        fd.append('status', document.getElementById('room-status').value);
        
        fd.append('price_per_night', document.getElementById('room-price').value);

        fd.append('location', document.getElementById('room-location').value);
        fd.append('address', document.getElementById('room-address').value);
        fd.append('description', document.getElementById('room-description').value);
        
        fd.append('price_per_night', document.getElementById('price-per-night').value);
        const files = document.getElementById('room-images').files;
        Array.from(files).forEach(file => fd.append('images', file));

        try {
            const url = currentMode === 'create' ? '/api/admin/rooms' : `/api/admin/rooms/${roomId}`;
            const method = currentMode === 'create' ? 'POST' : 'PUT';
            await apiFetch(url, { method, body: fd });
            
            document.getElementById('modal-success-message').textContent = 
                currentMode === 'create' ? '‚úÖ Th√™m ph√≤ng th√†nh c√¥ng!' : '‚úÖ C·∫≠p nh·∫≠t ph√≤ng th√†nh c√¥ng!';
            
            setTimeout(() => {
                closeRoomModal();
                fetchAndRenderAll();
            }, 1000);
        } catch (error) {
            document.getElementById('modal-error-message').textContent = '‚ùå ' + error.message;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = currentMode === 'create' ? '‚úÖ Th√™m Ph√≤ng' : 'üíæ L∆∞u Thay ƒê·ªïi';
        }
    });

    async function deleteRoom(roomId) {
        if (confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng n√†y kh√¥ng?')) {
            try {
                await apiFetch(`/api/admin/rooms/${roomId}`, { method: 'DELETE' });
                alert('‚úÖ X√≥a ph√≤ng th√†nh c√¥ng!');
                fetchAndRenderAll();
            } catch (error) {
                alert(`‚ùå L·ªói khi x√≥a ph√≤ng: ${error.message}`);
            }
        }
    }
    
    // H√†m n√†y CH·ªà hi·ªÉn th·ªã ·∫£nh M·ªöI CH·ªåN (t·ª´ input file)
    document.getElementById('room-images').addEventListener('change', function(e) {
        // Ch√∫ng ta KH√îNG x√≥a ·∫£nh c≈© khi ch·ªçn ·∫£nh m·ªõi, ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y c·∫£ 2
        // const preview = document.getElementById('image-preview');
        // preview.innerHTML = ''; // <-- D√≤ng n√†y ƒë√£ b·ªã x√≥a trong h√†m `openRoomModal`
        
        const preview = document.getElementById('image-preview');

        Array.from(e.target.files).forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                // Th√™m 'remove-image' cho ·∫£nh M·ªöI
                div.innerHTML = `<img src="${ev.target.result}"><div class="remove-image" onclick="this.parentElement.remove()">√ó</div>`;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    });

    async function fetchRoomTypes() {
        const sel = document.getElementById('room-type-id');
        try {
            ROOM_TYPES = await apiFetch('/api/admin/room-types');
            sel.innerHTML = ROOM_TYPES.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        } catch (err) {
            sel.innerHTML = '<option value="">‚ùå L·ªói t·∫£i lo·∫°i ph√≤ng</option>';
        }
    }

    // Logout handler
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
                localStorage.removeItem("token");
                alert("ƒê√£ ƒëƒÉng xu·∫•t!");
                window.location.href = "http://localhost:5500/login.html";
            }
        });
    }

    fetchRoomTypes();
    fetchAndRenderAll();
    </script>
</body>
</html>